# -*- coding: utf-8 -*-
"""AI automation

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1n2H2UaC8OGjkXlDrPc5_HxvZvnSkPRtD
"""

import streamlit as st
import pandas as pd
import numpy as np
import base64

# -----------------------------
# APP CONFIG
# -----------------------------
st.set_page_config(
    page_title="AI Lead Generation Analyzer",
    page_icon="‚ö°",
    layout="wide"
)

# -----------------------------
# HEADER
# -----------------------------
st.markdown("""
    <h1 style='text-align:center; color:#4CAF50;'>‚ö° AI Lead Generation Analyzer</h1>
    <p style='text-align:center; font-size:18px;'>Upload your ad performance CSV and instantly get insights, lead scores, cleaning, and enriched data.</p>
""", unsafe_allow_html=True)

# -----------------------------
# SIDEBAR
# -----------------------------
st.sidebar.header("Upload Your Dataset")
uploaded_file = st.sidebar.file_uploader("Upload CSV File", type=["csv"])

# -----------------------------
# FUNCTION: Download Link
# -----------------------------
def download_link(df, filename, link_text):
    csv = df.to_csv(index=False).encode()
    b64 = base64.b64encode(csv).decode()
    href = f'<a href="data:file/csv;base64,{b64}" download="{filename}">{link_text}</a>'
    return href

# -----------------------------
# PROCESS
# -----------------------------
if uploaded_file:
    st.success("File successfully uploaded!")

    df = pd.read_csv(uploaded_file)

    st.subheader("üìä Raw Data Preview")
    st.dataframe(df.head())

    # -----------------------------
    # CLEANING
    # -----------------------------
    st.subheader("üßπ Cleaning Dataset")
    df.columns = [col.strip().lower().replace(" ", "_") for col in df.columns]

    # Fill missing numeric
    num_cols = df.select_dtypes(include=[np.number]).columns
    df[num_cols] = df[num_cols].fillna(df[num_cols].mean())

    # Fill missing text
    obj_cols = df.select_dtypes(include=["object"]).columns
    df[obj_cols] = df[obj_cols].fillna("unknown")

    st.success("Dataset cleaned.")

    # -----------------------------
    # FEATURE ENGINEERING
    # -----------------------------
    st.subheader("‚öôÔ∏è Feature Engineering")

    if "clicks" in df.columns and "impressions" in df.columns:
        df["ctr"] = (df["clicks"] / (df["impressions"] + 1)) * 100
    if "spend" in df.columns and "clicks" in df.columns:
        df["cpc"] = df["spend"] / (df["clicks"] + 1)
    if "spend" in df.columns and "leads" in df.columns:
        df["cpl"] = df["spend"] / (df["leads"] + 1)

    # Lead scoring
    df["lead_score"] = (
        (df.get("ctr", 0) * 0.2)
        + (1 / (df.get("cpc", 1))) * 0.3
        + (1 / (df.get("cpl", 1))) * 0.5
    )

    st.success("Features successfully added.")

    st.subheader("üìà Enriched Data Preview")
    st.dataframe(df.head())

    # -----------------------------
    # INSIGHTS
    # -----------------------------
    st.subheader("üîç Insights")

    col1, col2, col3 = st.columns(3)
    col1.metric("Average CTR", f"{df['ctr'].mean():.2f}%")
    col2.metric("Average CPC", f"${df['cpc'].mean():.2f}")
    col3.metric("Average CPL", f"${df['cpl'].mean():.2f}")

    st.markdown("---")
    st.write("### üî• Top Performing Campaigns")
    st.dataframe(df.sort_values("lead_score", ascending=False).head(5))

    # -----------------------------
    # DOWNLOAD CLEANED DATA
    # -----------------------------
    st.markdown("### üì• Download Processed Dataset")
    st.markdown(download_link(df, "processed_lead_data.csv", "‚¨á Click here to download your cleaned CSV"), unsafe_allow_html=True)

else:
    st.info("Please upload a CSV file to begin.")