# -*- coding: utf-8 -*-
"""AI automation

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1n2H2UaC8OGjkXlDrPc5_HxvZvnSkPRtD
"""

import streamlit as st
import pandas as pd
import numpy as np
import xgboost as xgb
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime
import altair as alt
from sklearn.metrics import mean_squared_error

# ========================= CUSTOM CSS FOR ENHANCED UI/UX =========================
st.markdown("""
    <style>
    /* Overall App Theme */
    .stApp {
        background: linear-gradient(to bottom right, #f0f4f8, #d9e2ec);
        color: #2C3E50;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Sidebar Enhancements */
    [data-testid="stSidebar"] {
        background-color: #ffffff;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        padding: 1rem;
    }
    .stSidebar .stButton > button {
        background-color: #007BFF;
        color: white;
        border-radius: 8px;
    }
    .stSidebar .stButton > button:hover {
        background-color: #0056b3;
    }

    /* Metric Cards with Color Coding */
    [data-testid="stMetric"] {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    [data-testid="stMetricValue"] {
        color: #28a745;
    }
    [data-testid="stMetricDelta"] {
        font-weight: bold;
    }

    /* Headers and Expanders */
    h1, h2, h3 {
        color: #1A4876;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .stExpander {
        background-color: #ffffff;
        border: 1px solid #ced4da;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Chart Custom Colors */
    :root {
        --primary-color: #3498DB;
        --secondary-color: #E74C3C;
        --accent-color: #F1C40F;
        --success-color: #2ECC71;
        --warning-color: #F39C12;
    }

    /* Progress Bars and Spinners */
    .stSpinner {
        color: var(--primary-color);
    }
    </style>
""", unsafe_allow_html=True)

# ========================= CONFIG =========================
st.set_page_config(page_title="AI Marketing ROI Analyzer Pro", layout="wide", initial_sidebar_state="expanded")
st.title("üöÄ AI Marketing Campaign ROI Analyzer Pro")
st.markdown("### Data-Driven Insights, AI Predictions & Budget Optimization ‚Äî Showcase Your Expertise")
st.markdown("Elevate your marketing strategy with interactive visuals, unique analytics, and customizable features. Built to impress clients!")

# Load pre-trained model with improved error handling
@st.cache_resource
def load_model():
    try:
        model = xgb.XGBRegressor()
        model.load_model("roi_model.json")
        st.info("‚úÖ XGBoost Model Loaded Successfully")
        return model
    except Exception as e:
        st.warning(f"‚ö†Ô∏è Model Loading Error: {e}. Falling back to demo mode.")
        return None

model = load_model()

# ========================= SIDEBAR WITH ADVANCED UI/UX =========================
# Initialize uploaded_file to None before the sidebar
uploaded_file = None

with st.sidebar:
    st.header("üõ†Ô∏è Analysis Controls")
    st.markdown("Tailor the app to your needs for a personalized experience")

    # Enhanced Toggle with Icons
    use_demo = st.checkbox("üìä Use Demo Data", value=True, help="Quickly test with realistic sample campaigns")

    # Uploader with Progress Feedback
    if not use_demo:
        uploaded_file = st.file_uploader("üìÇ Upload Campaign CSV", type=["csv"], help="Drag & drop or browse. Supports large files!")
        if uploaded_file:
            with st.spinner("Processing upload..."):
                pass  # Placeholder for future enhancements

    # Expanded Filters Section
    st.markdown("---")
    st.subheader("üîé Advanced Filters")
    selected_channels = st.multiselect("Channels to Analyze", options=['Google', 'Meta', 'LinkedIn'], default=['Google', 'Meta', 'LinkedIn'], help="Select multiple for comparison")
    date_range = st.date_input("Date Range", value=(datetime.now().date() - pd.Timedelta(days=365), datetime.now().date()), help="Filter by campaign dates")
    min_spend, max_spend = st.slider("Spend Range ($)", 0, 10000, (0, 10000), step=100, help="Focus on budgets that matter")

    # New Feature: Color Theme Selector
    theme = st.selectbox("üé® Choose Theme", options=["Light Mode", "Dark Mode", "Vibrant Mode"], help="Switch for better visibility")
    if theme == "Dark Mode":
        st.markdown("<style>.stApp {background: linear-gradient(to bottom right, #2C3E50, #1A1A2E); color: #FFFFFF;}</style>", unsafe_allow_html=True)
    elif theme == "Vibrant Mode":
        st.markdown("<style>.stApp {background: linear-gradient(to bottom right, #FFEBEE, #E8EAF6); color: #212121;}</style>", unsafe_allow_html=True)

    st.info("Pro Tip: Use filters to drill down into high-ROI segments!")

# ========================= DATA LOADING & CLEANING =========================
df = None  # Initialize df

if use_demo:
    try:
        df = pd.read_csv("/content/lead_generation_csv-sheet1-sourcetable.csv")
        st.success("‚úÖ Demo Data Loaded: Explore realistic marketing campaigns")
    except Exception as e:
        st.error(f"‚ùå Demo file not found: {e}. Please upload your data.")
        st.stop()
else:
    if uploaded_file is not None:
        try:
            with st.spinner("Loading and cleaning data..."):
                df = pd.read_csv(uploaded_file)
            st.success(f"‚úÖ {len(df)} Campaigns Loaded from {uploaded_file.name}")
        except Exception as e:
            st.error(f"‚ùå Error loading file: {e}")
            st.stop()
    else:
        st.warning("‚ö†Ô∏è Please upload a CSV file to continue, or enable 'Use Demo Data'")
        st.stop()

# Enhanced Cleaning with Logging
clean_log = []
for col in ['Spend', 'Revenue', 'Impressions', 'Clicks', 'Conversions']:
    if col in df.columns:
        df[col] = pd.to_numeric(df[col].astype(str).str.replace('[$,]', '', regex=True), errors='coerce').fillna(0)
        clean_log.append(f"Cleaned {col}")
if 'Date' in df.columns:
    df['Date'] = pd.to_datetime(df['Date'], errors='coerce')
st.caption(f"Data Cleaning Summary: {', '.join(clean_log)}")

# Apply Filters Dynamically
mask = df['Channel'].isin(selected_channels) & (df['Spend'].between(min_spend, max_spend))
if 'Date' in df.columns:
    mask &= df['Date'].between(pd.Timestamp(date_range[0]), pd.Timestamp(date_range[1]))
df_filtered = df[mask].copy()

# Check if filtered data is empty
if len(df_filtered) == 0:
    st.warning("‚ö†Ô∏è No data matches your filters. Please adjust the filters in the sidebar.")
    st.stop()

# ========================= DASHBOARD METRICS WITH UNIQUE COLOR CODING =========================
st.subheader("üìà Executive Dashboard")
st.markdown("Key performance indicators with color-coded health checks")
cols = st.columns(5)
metrics = {
    "Campaigns": len(df_filtered),
    "Spend": df_filtered['Spend'].sum(),
    "Revenue": df_filtered['Revenue'].sum(),
    "ROI": ((df_filtered['Revenue'].sum() - df_filtered['Spend'].sum()) / df_filtered['Spend'].sum()) if df_filtered['Spend'].sum() > 0 else 0,
    "Conversions": df_filtered['Conversions'].sum() if 'Conversions' in df_filtered else 0
}

for i, (label, value) in enumerate(metrics.items()):
    delta_color = "normal" if (label == "ROI" and value > 0) or (label in ["Revenue", "Conversions"]) else "inverse"
    cols[i].metric(label, f"{value:,.2f}" if isinstance(value, float) else f"{value:,}", delta_color=delta_color)

# ========================= UNIQUE & ADVANCED ANALYSIS SECTION =========================
st.subheader("üåü Signature Insights: Unique Data Breakdowns")
st.markdown("Showcasing advanced analytics to highlight expertise ‚Äî correlations, distributions, trends, and more")

# Collapsible Sections for Better UX
with st.expander("üìã Interactive Data Table", expanded=True):
    st.dataframe(df_filtered.style.background_gradient(cmap="viridis", subset=['ROI', 'Spend'] if 'ROI' in df_filtered else ['Spend']), use_container_width=True, height=300)

vcol1, vcol2 = st.columns(2)

with vcol1:
    # Unique Viz 1: Enhanced Heatmap with Custom Colors
    st.markdown("#### üîó Metric Correlation Matrix")
    num_cols = df_filtered.select_dtypes(include=np.number).columns
    if len(num_cols) > 1:
        corr = df_filtered[num_cols].corr()
        fig_corr, ax_corr = plt.subplots(figsize=(8, 6))
        sns.heatmap(corr, annot=True, cmap="RdYlGn", center=0, ax=ax_corr, linewidths=0.5, linecolor='white')
        ax_corr.set_title("Deep Dive: How Metrics Interconnect", fontsize=14)
        st.pyplot(fig_corr)
        plt.close(fig_corr)
    else:
        st.info("Not enough numeric data for correlation.")

with vcol2:
    # Unique Viz 2: Boxplot + Swarm for Outlier Detection (Unique Twist)
    st.markdown("#### üìä ROI Distribution & Outliers by Channel")
    fig_box, ax_box = plt.subplots(figsize=(8, 6))
    sns.boxplot(x='Channel', y='ROI', data=df_filtered, palette="Set3", ax=ax_box)
    sns.swarmplot(x='Channel', y='ROI', data=df_filtered, color=".2", ax=ax_box, size=4)
    ax_box.set_title("Spot Outliers & Trends Across Channels", fontsize=14)
    st.pyplot(fig_box)
    plt.close(fig_box)

# Full-Width Unique Viz 3: Time Series Trend with Altair (Interactive)
if 'Date' in df_filtered.columns and df_filtered['Date'].notna().any():
    st.markdown("#### üìÖ ROI Trends Over Time (Interactive)")
    line_chart = (
        alt.Chart(df_filtered)
        .mark_line(point=True)
        .encode(
            x='Date:T',
            y='ROI:Q',
            color=alt.Color('Channel:N', scale=alt.Scale(range=['#3498DB', '#E74C3C', '#F1C40F'])),
            tooltip=['Date', 'ROI', 'Channel', 'Spend']
        )
        .interactive()
        .properties(width='container', height=300)
    )
    st.altair_chart(line_chart, use_container_width=True)

# New Feature: Custom KPI Benchmarks
st.markdown("#### üèÜ Performance Benchmarks")
benchmark_roi = df_filtered['ROI'].mean() * 1.1  # Arbitrary 10% above average
if benchmark_roi != 0:
    progress_value = min(1.0, max(0.0, metrics['ROI'] / benchmark_roi))
else:
    progress_value = 0.0
st.progress(progress_value)
st.caption(f"Current ROI vs. Benchmark ({benchmark_roi:.1%}): {'On Target!' if metrics['ROI'] >= benchmark_roi else 'Room for Growth'}")

# ========================= AI PREDICTIONS WITH IMPROVED UI =========================
st.subheader("ü§ñ AI-Powered Optimization")
if model is not None:
    if st.button("üîç Launch AI Analysis", type="primary"):
        try:
            with st.spinner("Analyzing with XGBoost..."):
                # Enhanced Feature Prep
                cat_cols = ['Channel', 'Age_Group', 'Gender', 'Location']
                available_cols = [col for col in cat_cols if col in df_filtered.columns]
                feature_cols = available_cols + ['Spend', 'Impressions']
                features = pd.get_dummies(df_filtered[feature_cols], drop_first=True)
                preds = model.predict(features)
                df_filtered['Predicted_ROI'] = preds
                mse = mean_squared_error(df_filtered['ROI'], preds) if 'ROI' in df_filtered else "N/A"

            st.success(f"AI Complete! Prediction Accuracy (MSE): {mse}")
            best_shift = df_filtered.loc[df_filtered['Predicted_ROI'].idxmax(), 'Channel']
            uplift = (df_filtered['Predicted_ROI'].mean() - df_filtered['ROI'].mean()) / df_filtered['ROI'].mean() if 'ROI' in df_filtered and df_filtered['ROI'].mean() != 0 else 0.15
            st.info(f"**Expert Recommendation:** Reallocate to {best_shift} for {uplift:.0%}+ uplift. Simulate below!")

            # New Feature: Simulation Slider
            shift_pct = st.slider("Simulate Budget Shift (%)", 0, 50, 20)
            sim_revenue = metrics['Revenue'] * (1 + (shift_pct / 100) * uplift)
            sim_roi = (sim_revenue - metrics['Spend']) / metrics['Spend'] if metrics['Spend'] > 0 else 0
            st.metric("Projected ROI", f"{sim_roi:.1%}", f"+{shift_pct}% Shift")

            # Predicted vs Actual Bar Chart
            fig_comp, ax_comp = plt.subplots()
            comp_df = pd.DataFrame({'Actual ROI': [metrics['ROI']], 'Predicted ROI': [df_filtered['Predicted_ROI'].mean()]})
            comp_df.plot(kind='bar', color=['#2ECC71', '#F39C12'], ax=ax_comp, rot=0)
            st.pyplot(fig_comp)
            plt.close(fig_comp)
        except Exception as e:
            st.error(f"Error during AI analysis: {e}")
else:
    st.info("Train and load your model for AI magic!")

# ========================= ADDED FEATURES: EXPORT, SHARE & MORE =========================
st.markdown("---")
st.subheader("üîó Share & Export Tools")
export_cols = st.columns(3)
with export_cols[0]:
    st.download_button("üíæ Filtered CSV", df_filtered.to_csv(index=False).encode('utf-8'), "pro_filtered_data.csv", mime="text/csv")
with export_cols[1]:
    st.download_button("üìà Insights JSON", df_filtered.describe().to_json().encode('utf-8'), "pro_insights.json", mime="application/json")
with export_cols[2]:
    if st.button("üìß Generate Report Email"):
        st.text_area("Quick Report", "Copy this summary for your team: [Insert AI Insights Here]")

# New Feature: Feedback Form
with st.expander("üí¨ Provide Feedback"):
    feedback = st.text_area("How can we improve this app?")
    if st.button("Submit Feedback"):
        st.success("Thanks! Your input helps us grow.")

st.caption("Masterfully Crafted by [Your Name] ‚Äî Impress Clients with Custom Solutions ($1K‚Äì$5K) | Demonstrating Top-Tier Data & UI Expertise")